name: üöÄ Deploy Backend to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy via SSH
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_KEY }}

    - name: Deploy to Server
      run: |
        ssh -o StrictHostKeyChecking=no root@143.198.222.151 << 'EOF'
          set -e
          set -x

          echo "‚û°Ô∏è Switching to project directory"
          cd /var/www/apicrm.mydevnxerra.com/NxerraCRM_BE
          
          echo "üîÅ Git Pull"
          git reset --hard origin/main
          git pull origin main

          echo "üì¶ Installing npm dependencies"
          if ! command -v npm &> /dev/null; then
            echo "‚ùå npm not found. Aborting."
            exit 127
          fi

          npm install --legacy-peer-deps

          echo "üöÄ Restarting PM2"
          if ! command -v pm2 &> /dev/null; then
            echo "‚ùå pm2 not found. Aborting."
            exit 127
          fi

          pm2 restart all || pm2 start index.js
        EOF
